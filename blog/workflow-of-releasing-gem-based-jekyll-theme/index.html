<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="utf-8">
        
        <script>
            const isDarkMode = localStorage.getItem('is_darkmode_set') === 'true';
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            }
        </script>
        
        <meta name="color-scheme" content="light dark">

        
        
        
            
            
                
                    
                    
                    
                    
                    
                    
                    
                    
                
            
                
                    
                    
                    
                    
                    
                    
                    
                    
                
            
                
                    
                    
                    
                    
                    
                    
                    
                    
                
            
                
                    
                    
                    
                    
                    
                    
                    
                    
                        
                        
                            
                            
                            
                                
                            
                        
                    
                
            
            
            
        
        
        
            <link rel="me" href="https:&#x2F;&#x2F;mastodon.gamedev.place&#x2F;@bitbraindev">
        

        
        

        
        <link rel="alternate"
              type="application/atom+xml"
              title="bitbrain feed"
              href="https://bitbra.in/atom.xml">
        

        
        <link rel="icon" type="image/webp" href="https://bitbra.in/favicon.webp?h=0d4aaa30fc76312a3ebe">
        <link rel="icon" type="image/png" href="https://bitbra.in/favicon.png?h=44b76b5cf66397d57be1" sizes="32x32">

        <link rel="stylesheet" href="https://bitbra.in/css/style.css?h=02ededa3d6ae0ee7a513"/>
        <link rel="stylesheet" href="https://bitbra.in/line-awesome/css/line-awesome.min.css?h=ce61a18cf084f1500379"/>
        <script src="https://bitbra.in/js/main.js?h=6ebbb40a03fcd672fbed" defer></script>
        
    <title>Workflow of releasing a gem-based Jekyll theme | bitbrain</title>
    
    
    
    
    
    
        
    
    
        
        
            
        
    
    <meta property="og:type" content="article">
    <meta property="og:title" content="Workflow of releasing a gem-based Jekyll theme">
    
    <meta property="og:url" content="https:&#x2F;&#x2F;bitbra.in&#x2F;blog&#x2F;workflow-of-releasing-gem-based-jekyll-theme&#x2F;">
    <meta property="og:site_name" content="bitbrain">
    <meta property="og:image" content="https:&#x2F;&#x2F;bitbra.in&#x2F;images&#x2F;hello.jpg">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Workflow of releasing a gem-based Jekyll theme">
    
    <meta name="twitter:image" content="https:&#x2F;&#x2F;bitbra.in&#x2F;images&#x2F;hello.jpg">
    
    
    
        
        
            
                
                
                
                
                
                
                
                
            
        
            
                
                
                
                
                
                
                
                
            
        
            
                
                
                
                
                
                
                
                
            
        
            
                
                
                
                
                
                
                
                
                    
                    
                        
                        
                        
                            
                        
                    
                
            
        
        
        
    
    
    
        
        
        
        
            
            
            <meta name="fediverse:creator" content="@bitbraindev@mastodon.gamedev.place">
        
    

    </head>

    <body class="bg-white dark:bg-slate-900 transition ease-in-out">
        <section>
            
    
<div class="sticky top-0 bg-slate-100 dark:bg-slate-800">
    <div class="container mx-auto flex place-content-between
        py-16 lg:py-8 font-sans text-6xl lg:text-2xl text-slate-900
        dark:text-white">
        <div class="flex">
            
            
            
            
            <a class="m-0 p-0 text-slate-900 hover:text-slate-700
                            dark:text-white dark:hover:text-white" href="&#x2F;blog&#x2F;">
                /blog
            </a>
            
            
            
            
            
            
        </div>
        <div class="flex gap-4 header-links">
            <div id="back-to-top" class="hidden cursor-pointer">
                <i class="las la-level-up-alt"></i>
            </div>
            <a href="/"><i class="las la-home"></i></a>
            
            <a href="https://bitbra.in/atom.xml"><i class="las la-rss"></i></a>
            
            <div id="darkmode-toggle" class="cursor-pointer">
                <div class="hidden dark:inline">
                    <i class="las la-sun"></i>
                </div>
                <div class="inline dark:hidden">
                    <i class="las la-moon"></i>
                </div>
            </div>
        </div>
    </div>
</div>

    <div class="container mb-16">
        <div class="mt-4 font-serif text-slate-600 dark:text-slate-500 text-4xl lg:text-base">
            2021-10-05
        </div>
        <h1 class="w-full mt-4 mb-8 font-serif text-8xl lg:text-4xl text-slate-900 dark:text-slate-300">
            Workflow of releasing a gem-based Jekyll theme
        </h1>
        <div class="w-100 border-t mb-8 border-slate-300 dark:border-slate-700"></div>
        <div class="prose-boring">
            <p>This <a href="https://jekyllrb.com/">Jekyll</a>-based blog has been built with a custom theme created called <a href="https://github.com/bitbrain/jekyll-dash">jekyll-dash</a>. Initially, I built this theme just to share it with others, however, more and more people started using it over the past few months.</p>
<p><a href="https://github.com/bitbrain/jekyll-dash"><img src="/images/jekyll-dash-logo.webp" alt="jekyll-dash-logo" /></a></p>
<p>In this article I want to highlight some of the challenges I faced trying to maintain this theme for a lot of people and the workflow I introduced that helped me to overcome these challenges.</p>
<h1 id="an-auto-update-theme">An "auto-update" theme</h1>
<p>When I first started this theme I found it quite annoying that I constantly had to manually update my Jekyll files such as layouts, Sass and pages to apply a change to my blog. Especially, when trying to keep the theme in its <a href="https://github.com/bitbrain/jekyll-dash">own dedicated repository</a> this can become a demanding chore.</p>
<p>The solution to this was to bundle my theme as a so called <a href="https://rubygems.org/">Ruby gem</a> and then use that gem within the <code>_config.yml</code> of Jekyll:</p>
<pre data-lang="yml" style="background-color:#090a0c;color:#dae4ed;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#4ebc6b;">theme</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">jekyll-dash
</span></code></pre>
<p>Jekyll will automatically apply the theme if it is specified as a gem within <code>Gemfile</code>:</p>
<pre style="background-color:#090a0c;color:#dae4ed;"><code><span>gem &#39;jekyll-dash&#39;
</span></code></pre>
<p>Whenever I push a new version of the gem to the public rubygems repository, rebuilding my site would use the new changes and automatically include them - neat!</p>
<h1 id="limitations-of-github-pages">Limitations of Github Pages</h1>
<p>Unfortunately, I quickly had to realise that a lot of people were unable to use my theme natively within Github pages. Github are actually the creators behind Jekyll and when you create a repository containing Jekyll files, it will automatically build them for you and publish them <a href="https://docs.github.com/en/pages/getting-started-with-github-pages/creating-a-github-pages-site">when the Github pages feature is enabled</a>.</p>
<p>There was just one problem: <a href="https://pages.github.com/versions/">Github pages did not support Jekyll 4.x</a> at the moment of this writing but only Jekyll 3.x. This becomes a problem because my theme was natively built with Jekyll 4.</p>
<p>Therefore, I had to introduce a multi-version workflow:</p>
<ul>
<li>version <code>1.x</code> will support Jekyll 3</li>
<li>version <code>2.x</code> will support Jekyll 4</li>
</ul>
<p>I created separate branches for those and specified the Jekyll version explicitly within the <code>.gemspec</code> file of <a href="https://github.com/bitbrain/jekyll-dash/blob/main/jekyll-dash.gemspec">jekyll-dash</a>:</p>
<pre style="background-color:#090a0c;color:#dae4ed;"><code><span>spec.add_runtime_dependency &quot;jekyll&quot;, &quot;~&gt; 4.0&quot;
</span></code></pre>
<p>This worked very well for my usecase and I was able to use the theme natively in Github pages.</p>
<p>For what reason would I want to use Jekyll outside of the native Github pages integration then? Well, due to security reasons, Github Pages does only allow a very specific set of Jekyll plugins to be enabled. This restricts customisation of the site. For example, I also needed the following features:</p>
<ul>
<li>gravatar support</li>
<li>auto-generated tags and tag cloud</li>
</ul>
<p>The solution was to build the site externally outside of Github Pages but then push the generated site <a href="https://github.com/bitbrain/bitbrain.github.io">onto a Github Pages enabled repository</a>. I achieved that by using <a href="https://travis-ci.org/">travis-ci.org</a> which became eventually difficult to manage. As a result, I left Travis behind and moved over to <a href="https://docs.github.com/en/actions">Github Actions</a>.</p>
<h1 id="improving-the-workflow">Improving the workflow</h1>
<p>My initial release workflow looked as follows:</p>
<ol>
<li>push a new commit to the <code>main</code> branch containing the updated version within the <code>.gemspec</code></li>
<li>push a new tag for the given commit</li>
<li>release the gem (see script below)</li>
</ol>
<pre data-lang="yml" style="background-color:#090a0c;color:#dae4ed;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#4ebc6b;">before_install</span><span style="color:#b7c3ce;">:
</span><span style="color:#b7c3ce;">- </span><span style="color:#4ebc6b;">gem install bundler -v 2.0.1
</span><span style="color:#4ebc6b;">script</span><span style="color:#b7c3ce;">:
</span><span style="color:#b7c3ce;">- </span><span style="color:#4ebc6b;">bundle install
</span><span style="color:#4ebc6b;">deploy</span><span style="color:#b7c3ce;">:
</span><span>  </span><span style="color:#4ebc6b;">provider</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">rubygems
</span><span>  </span><span style="color:#4ebc6b;">api_key</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">$RUBYGEMS_API_KEY
</span><span>  </span><span style="color:#4ebc6b;">gem</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">jekyll-dash
</span><span>  </span><span style="color:#ea9433;">on</span><span style="color:#b7c3ce;">:
</span><span>    </span><span style="color:#4ebc6b;">tags</span><span style="color:#b7c3ce;">: </span><span style="color:#ea9433;">true
</span><span>    </span><span style="color:#4ebc6b;">repo</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">bitbrain/jekyll-dash
</span></code></pre>
<p>There were a couple of issues with this approach:</p>
<ul>
<li>the pipeline ran outside of Github while Github support Github Actions out-of-the-box</li>
<li>unable to see what each release entails, as Github releases and git tags were not created for a new release</li>
<li>difficult to manage multiple major versions, as this pipeline would always deploy what the tag said. I had to be very careful to not cause unecessary merge conflicts</li>
<li>individual commits were not really built and tested. Especially for people trying to make contributions it was difficult to tell if their change would break the Jekyll build</li>
</ul>
<p>I discarded this workflow and introduced a completely new one built from scratch based on <strong>Github Actions</strong>:</p>
<ol>
<li>Build jekyll site for each individual commit and report on its status code</li>
<li>When committing to the branches <code>main</code> (v2.x) and <code>1.x</code> (v1.x) respectively, do the following:
<ul>
<li>extract the current gem version from the .gemspec file <a href="https://github.com/bitbrain/gemspec-fetch">with a custom-built Github action</a></li>
<li>check git history if a tag for the extracted gem version exists already</li>
<li>in case the tag does not exist yet, create a new git tag and push a new Github release</li>
</ul>
</li>
<li>Whenever a new tag has been pushed, build and publish the gem for that tag to rubygems.org</li>
</ol>
<p><img src="/images/jekyll-dash-build-tag.webp" alt="jekyll-dash-build" /></p>
<p>In order to check that the gem version exists as a tag, I am using the <code>github-tag-action</code>:</p>
<pre data-lang="yml" style="background-color:#090a0c;color:#dae4ed;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#b7c3ce;">- </span><span style="color:#4ebc6b;">name</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">üíé Extract gemspec info
</span><span>  </span><span style="color:#4ebc6b;">id</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">gemspec_fetch
</span><span>  </span><span style="color:#4ebc6b;">uses</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">bitbrain/gemspec-fetch@1.0.0
</span><span>  </span><span style="color:#4ebc6b;">with</span><span style="color:#b7c3ce;">:
</span><span>    </span><span style="color:#4ebc6b;">specfile</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">jekyll-dash.gemspec
</span><span style="color:#b7c3ce;">- </span><span style="color:#4ebc6b;">name</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">üïµÔ∏è‚Äç‚ôÇÔ∏è investigate if tag exists
</span><span>  </span><span style="color:#4ebc6b;">uses</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">mukunku/tag-exists-action@v1.0.0
</span><span>  </span><span style="color:#4ebc6b;">id</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">tag-check
</span><span>  </span><span style="color:#4ebc6b;">with</span><span style="color:#b7c3ce;">: 
</span><span>    </span><span style="color:#4ebc6b;">tag</span><span style="color:#b7c3ce;">: {</span><span>% </span><span style="color:#4ebc6b;">raw %</span><span style="color:#b7c3ce;">}&#39;</span><span style="color:#4ebc6b;">v${{ steps.gemspec_fetch.outputs.version }}</span><span style="color:#b7c3ce;">&#39;{</span><span>% </span><span style="color:#4ebc6b;">endraw %</span><span style="color:#b7c3ce;">}
</span><span>  </span><span style="color:#4ebc6b;">env</span><span style="color:#b7c3ce;">:
</span><span>    </span><span style="color:#4ebc6b;">GITHUB_TOKEN</span><span style="color:#b7c3ce;">: {</span><span>% </span><span style="color:#4ebc6b;">raw %</span><span style="color:#b7c3ce;">}</span><span style="color:#4ebc6b;">${{ secrets.GH_CREDENTIALS }}{% endraw %}
</span></code></pre>
<p>This allows me then to apply an <code>if</code> conditional on any other steps:</p>
<pre data-lang="yml" style="background-color:#090a0c;color:#dae4ed;" class="language-yml "><code class="language-yml" data-lang="yml"><span style="color:#b7c3ce;">- </span><span style="color:#4ebc6b;">name</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">üîñBuild tag
</span><span>  </span><span style="color:#4ebc6b;">if</span><span style="color:#b7c3ce;">: {</span><span>% </span><span style="color:#4ebc6b;">raw %</span><span style="color:#b7c3ce;">}</span><span style="color:#4ebc6b;">${{ steps.tag-check.outputs.exists == &#39;false&#39; }}{% endraw %}
</span><span>  </span><span style="color:#4ebc6b;">id</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">tag_version
</span><span>  </span><span style="color:#4ebc6b;">uses</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">mathieudutour/github-tag-action@v5.6
</span><span>  </span><span style="color:#4ebc6b;">with</span><span style="color:#b7c3ce;">:
</span><span>    </span><span style="color:#4ebc6b;">github_token</span><span style="color:#b7c3ce;">: {</span><span>% </span><span style="color:#4ebc6b;">raw %</span><span style="color:#b7c3ce;">}</span><span style="color:#4ebc6b;">${{ secrets.GH_CREDENTIALS }}{% endraw %}
</span><span>    </span><span style="color:#4ebc6b;">default_bump</span><span style="color:#b7c3ce;">: </span><span style="color:#ea9433;">false
</span><span>    </span><span style="color:#4ebc6b;">custom_tag</span><span style="color:#b7c3ce;">:  {</span><span>% </span><span style="color:#4ebc6b;">raw %</span><span style="color:#b7c3ce;">}</span><span style="color:#4ebc6b;">${{ steps.gemspec_fetch.outputs.version }}{% endraw %}
</span><span>    </span><span style="color:#4ebc6b;">tag_prefix</span><span style="color:#b7c3ce;">: </span><span style="color:#4ebc6b;">v
</span></code></pre>
<p>The slightly tricky part was to extract the version from the .gemspec file. For that I build <a href="https://github.com/bitbrain/gemspec-fetch">my own Github Action</a> that is using <a href="https://github.com/packsaddle/ruby-parse_gemspec-cli">parse-gemspec-cli</a> to <a href="https://github.com/bitbrain/gemspec-fetch/blob/main/entrypoint.sh">extract the metadata accordingly</a>:</p>
<pre data-lang="bash" style="background-color:#090a0c;color:#dae4ed;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#353e4a;">#!/bin/bash
</span><span>
</span><span style="color:#ffffff;">SPEC_DATA</span><span style="color:#b7c3ce;">=$(</span><span style="color:#ffffff;">parse-gemspec-cli </span><span style="color:#b7c3ce;">$</span><span style="color:#ffffff;">INPUT_SPECFILE</span><span style="color:#b7c3ce;">)
</span><span>
</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">&quot;</span><span style="color:#4ebc6b;">::set-output name=name::</span><span style="color:#b7c3ce;">$(</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">$</span><span style="color:#ffffff;">SPEC_DATA </span><span style="color:#b7c3ce;">| </span><span style="color:#ffffff;">jq</span><span style="color:#b7c3ce;"> -</span><span style="color:#ffffff;">r </span><span style="color:#b7c3ce;">&#39;</span><span style="color:#4ebc6b;">.name</span><span style="color:#b7c3ce;">&#39;)&quot;
</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">&quot;</span><span style="color:#4ebc6b;">::set-output name=description::</span><span style="color:#b7c3ce;">$(</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">$</span><span style="color:#ffffff;">SPEC_DATA </span><span style="color:#b7c3ce;">| </span><span style="color:#ffffff;">jq</span><span style="color:#b7c3ce;"> -</span><span style="color:#ffffff;">r </span><span style="color:#b7c3ce;">&#39;</span><span style="color:#4ebc6b;">.description</span><span style="color:#b7c3ce;">&#39;)&quot;
</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">&quot;</span><span style="color:#4ebc6b;">::set-output name=summary::</span><span style="color:#b7c3ce;">$(</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">$</span><span style="color:#ffffff;">SPEC_DATA </span><span style="color:#b7c3ce;">| </span><span style="color:#ffffff;">jq</span><span style="color:#b7c3ce;"> -</span><span style="color:#ffffff;">r </span><span style="color:#b7c3ce;">&#39;</span><span style="color:#4ebc6b;">.summary</span><span style="color:#b7c3ce;">&#39;)&quot;
</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">&quot;</span><span style="color:#4ebc6b;">::set-output name=version::</span><span style="color:#b7c3ce;">$(</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">$</span><span style="color:#ffffff;">SPEC_DATA </span><span style="color:#b7c3ce;">| </span><span style="color:#ffffff;">jq</span><span style="color:#b7c3ce;"> -</span><span style="color:#ffffff;">r </span><span style="color:#b7c3ce;">&#39;</span><span style="color:#4ebc6b;">.version</span><span style="color:#b7c3ce;">&#39;)&quot;
</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">&quot;</span><span style="color:#4ebc6b;">::set-output name=homepage::</span><span style="color:#b7c3ce;">$(</span><span style="color:#ffffff;">echo </span><span style="color:#b7c3ce;">$</span><span style="color:#ffffff;">SPEC_DATA </span><span style="color:#b7c3ce;">| </span><span style="color:#ffffff;">jq</span><span style="color:#b7c3ce;"> -</span><span style="color:#ffffff;">r </span><span style="color:#b7c3ce;">&#39;</span><span style="color:#4ebc6b;">.homepage</span><span style="color:#b7c3ce;">&#39;)&quot;
</span></code></pre>
<p>This new workflow allows me to build and test every single commit and it gives me full control of when I want to release a new gem: I simply bump the version of the gem manually within the .gemspec and Github will do the rest for me!</p>

        </div>
        
        
        
        <div class="bg-slate-100 dark:bg-slate-800 mt-12">
            <div class="flex items-stretch lg:items-stretch">
                
                
                
                
                    
                
                
                    
                    
                        
                    
                    <div class="author-box__media">
                        <img src="https:&#x2F;&#x2F;bitbra.in&#x2F;images&#x2F;hello.jpg" alt="" class="author-box__avatar"/>
                    </div>
                
                <div class="text-4xl lg:text-base text-slate-700 dark:text-slate-400 flex-1 author-box__content">
                    
                        <h2 class="font-serif text-6xl lg:text-2xl text-slate-900 dark:text-slate-300 m-0 author-box__title">bitbrain</h2>
                    
                    
                        <div class="font-sans text-5xl lg:text-xl text-slate-600 dark:text-slate-500 mb-4 author-box__subtitle">Lead Software Engineer. Godot Engine evangelist.</div>
                    
                    
                    
                        
                    
                    
                        <div class="mt-2 text-8xl lg:text-4xl flex gap-3 homepage-social author-box__social">
                            
                                
                                <div class="text-slate-500 hover:text-slate-700 transition">
                                    <a href="https:&#x2F;&#x2F;github.com&#x2F;bitbrain" target="_blank" rel="me noopener noreferrer">
                                        <i class="lab la-github"></i>
                                    </a>
                                </div>
                                
                            
                                
                                <div class="text-slate-500 hover:text-slate-700 transition">
                                    <a href="https:&#x2F;&#x2F;youtube.com&#x2F;@bitbraindev" target="_blank" rel="me noopener noreferrer">
                                        <i class="lab la-youtube"></i>
                                    </a>
                                </div>
                                
                            
                                
                                <div class="text-slate-500 hover:text-slate-700 transition">
                                    <a href="https:&#x2F;&#x2F;bsky.app&#x2F;profile&#x2F;bitbra.in" target="_blank" rel="me noopener noreferrer">
                                        <i class="las la-at"></i>
                                    </a>
                                </div>
                                
                            
                                
                                <div class="text-slate-500 hover:text-slate-700 transition">
                                    <a href="https:&#x2F;&#x2F;mastodon.gamedev.place&#x2F;@bitbraindev" target="_blank" rel="me noopener noreferrer">
                                        <i class="lab la-mastodon"></i>
                                    </a>
                                </div>
                                
                            
                        </div>
                    
            </div>
        </div>
        
    </div>

        </section>
    </body>
</html>
